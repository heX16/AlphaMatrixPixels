# Подробная настройка Cygwin и Visual Studio Code для C++ на Windows

С середины 1990-х годов [Cygwin](https://cygwin.com/index.html) предоставляет мощную среду для портирования Unix-программ в мир Windows. Технически Cygwin предоставляет "POSIX" слой (POSIX — стандарт для обеспечения совместимости между операционными системами). С практической точки зрения, Cygwin позволяет Windows PC запускать оболочку `bash` с большинством распространенных Unix-команд.

Этот документ проведет вас через настройку среды программирования Windows/Cygwin с использованием:
- IDE VSCode, работающей нативно на Windows
- Java, работающей нативно на Windows
- `g++`, `make` и `gdb` в Cygwin

## Преимущества этого подхода

- Довольно простая настройка
- Нет необходимости запускать пакет X-сервера
- Можно выполнять большую часть работы в Windows, но при этом иметь возможность перейти в окно Cygwin `bash` для операций командной строки

## Недостатки этого подхода

- Cygwin использует пути в стиле Unix. Например, если вы работаете в директории проекта с исходным кодом, содержащимся в директории `cpp` внутри внешней директории `src`, в Windows вы бы обращались к этому исходному коду как `src\cpp\`, но в Cygwin это было бы `src/cpp`.
- Абсолютные пути сложнее. Директория Windows `C:\Users\yourName\projects` в Cygwin была бы `/cygdrive/c/Users/yourName/projects`.
- Это может вызвать некоторую путаницу, когда программы Windows (например, Eclipse) должны взаимодействовать с программами Cygwin (например, `g++` или `gdb`).

## 1. Установка компилятора Cygwin

1. Перейдите на сайт [Cygwin](http://www.cygwin.com/) и следуйте инструкциям для загрузки и запуска программы установки Cygwin.
2. Рекомендуется установить базовую систему Cygwin по умолчанию при первом "проходе" без добавления каких-либо дополнительных пакетов (включая компилятор).
3. Проверьте установку, чтобы убедиться, что она работает. У вас должна быть новая запись в меню `Start` для запуска `Cygwin terminal`. Попробуйте и убедитесь, что это работает. Должна запуститься оболочка команд `bash`, которая принимает команды, такие как:
   - `pwd`: для вывода текущей рабочей директории
   - `ls`: для вывода списка файлов и директорий в текущей рабочей директории
   - `cd` *directory*: для изменения текущей рабочей директории
   - `exit`: для закрытия сессии терминала
4. Если все выглядит хорошо, запустите программу установки Cygwin снова и добавьте следующее: `g++`, `gdb`, `gcc-debuginfo`, `git` и `make`.
   > Рекомендуется всегда получать версию с наибольшим номером, которая *не* помечена как "Test".
   > 
   > **Однако**, если у вас возникают проблемы с работой отладчика gdb, попробуйте использовать версию 9.2.1 `gdb`.
5. Проверьте установку, чтобы убедиться, что она работает. Снова запустите `Cygwin terminal`. Выполните команды:
   ```bash
   g++ --version
   gdb --version
   make --version
   ```
   Каждая должна привести к сообщению, указывающему, что программа запустилась успешно.

## 2. Установка VSCode

Следующий шаг — установка IDE VSCode.

1. Получите VSCode [здесь](https://code.visualstudio.com/download) и установите его на ваш PC.
2. Запустите VSCode. В свежеустановленном состоянии он не знает, как работать с C++ или Java, и не знает, как выполнять удаленную разработку. Мы исправим эти ограничения, сразу установив некоторые расширения.
   - Нажмите на кнопку расширений, чтобы войти в список расширений.
3. Используйте текстовое поле в верхней части левой колонки для поиска "C++". Найдите и установите следующие расширения:
   - C/C++
   - Better C/C++ Syntax
4. Если вас интересует программирование на Java, используйте текстовое поле в верхней части левой колонки для поиска "Java". Найдите и установите следующие расширения:
   - Java Extension Pack
5. Выйдите из VSCode.

## 3. Добавление компиляторов в PATH

VSCode должен иметь возможность найти ваш недавно установленный компилятор. Есть шанс, что он найдет их, если вы просто установили их в их расположениях по умолчанию, но я считаю, что все работает более плавно, если компилятор и связанные инструменты находятся в вашем PATH.

`%PATH%` в Windows — это список директорий, где Windows будет искать исполняемые программы.

Есть два способа сделать это:

### 3.1 "Постоянный" способ

1. Добавьте директорию `bin`, содержащую `g++` и другие исполняемые файлы Cygwin (`C:\cygwin64\bin`, если вы приняли расположение по умолчанию при установке Cygwin), [в ваш Windows PATH](http://msdn.microsoft.com/en-us/library/office/ee537574%28v=office.14%29.aspx).

2. Проверьте, что вы сделали это успешно: Откройте окно Windows `cmd`. (Нажмите кнопку запуска Windows и введите "cmd").
   Введите следующие команды:
   ```bash
   g++ --version
   gdb --version
   make --version
   ```
   Каждая должна привести к сообщению, указывающему, что программа была найдена и запущена успешно.

### 3.2 Временный способ

Создайте Windows batch-файл для запуска VSCode, например, `cygVSCode.bat`, который добавляет директорию `bin`, содержащую `g++` и другие исполняемые файлы Cygwin (`C:\cygwin64\bin`, если вы приняли расположение по умолчанию при установке Cygwin), в Windows PATH и затем запускает VSCode:

**cygVSCode.bat**

```batch
SET PATH=%PATH%;c:\cygwin64\bin
"C:\Users\jdoe\AppData\Local\Programs\Microsoft VS Code\Code.exe"
```

Измените этот путь на фактический путь, где хранится ваш файл `bin` Cygwin, и измените этот путь на место, где вы установили VSCode.

> Если вы выберете этот подход, а не "постоянное" изменение `%PATH%`, вам нужно будет помнить об использовании этого batch-файла для запуска VSCode всякий раз, когда вы хотите работать в C++.

Рекомендуется поместить этот `.bat` файл прямо на рабочий стол, чтобы можно было легко запустить его двойным щелчком.

## 4. Попробуйте это

Теперь вы должны иметь возможность создавать проекты C++, редактировать код C++, компилировать его и отлаживать.

Попробуйте упражнения VSCode из CS252, пропуская шаг подключения к удаленному серверу.

### 4.1 Задача сборки

Выберите файл `.cpp`. Затем из меню `Terminal` выберите "Configure Default Build Task".  
Выберите "C/C++: g++.exe build active file".

#### Если ваш проект имеет Makefile:

В новом файле `tasks.json`:
1. Измените `label` на "C/C++ make -k"
2. Измените `command` на "make"
3. Измените `args` на `["-k"]`
4. Измените опцию `cwd` на `"${workspaceFolder}"`

Вы должны получить что-то вроде этого:

```json
{
  // See https://go.microsoft.com/fwlink/?LinkId=733558
  // for the documentation about the tasks.json format
  "version": "2.0.0",
  "tasks": [
    {
      "type": "cppbuild",
      "label": "C/C++: make -k",
      "command": "make",
      "args": [
        "-k"
      ],
      "options": {
        "cwd": "${workspaceFolder}"
      },
      "problemMatcher": [
        "$gcc"
      ],
      "group": {
        "kind": "build",
        "isDefault": true
      },
      "detail": "compiler: C:\\cygwin64\\bin\\cpp.exe"
    }
  ]
}
```

#### Если ваш проект не имеет Makefile:

В новом файле `tasks.json`:
1. Измените `label` на "C/C++ build all"
2. В области `args` измените `"${file}"` на `"*.cpp"`.
3. Измените опцию `cwd` на `"${workspaceFolder}"`

Вы должны получить что-то вроде этого:

```json
{
  "version": "2.0.0",
  "tasks": [
    {
      "type": "cppbuild",
      "label": "C/C++: g++.exe build all",
      "command": "C:\\cygwin64\\bin\\g++.exe",
      "args": [
        "-fdiagnostics-color=always",
        "-g",
        "*.cpp",
        "-o",
        "${fileDirname}\\${fileBasenameNoExtension}.exe"
      ],
      "options": {
        "cwd": "${workspaceFolder}"
      },
      "problemMatcher": [
        "$gcc"
      ],
      "group": {
        "kind": "build",
        "isDefault": true
      },
      "detail": "compiler: C:\\cygwin64\\bin\\g++.exe"
    }
  ]
}
```

### 4.2 Задача запуска (Launch Task)

Чтобы настроить задачу запуска (для запуска отладчика), выберите любой файл `.cpp`. Затем в меню `Run` выберите "Add Configuration". Выберите "C++ (gdb/lldb)". Затем снова выберите ту же запись меню и выберите "C/C++ (gdb) Launch".

В результирующем файле `launch.json`:

1. Измените `name` на "(gdb) CygWin launch".
2. Для программы укажите `"${workspaceFolder}/???.exe"`, заменив `???` на имя вашей исполняемой программы.
3. Если вашей программе нужны аргументы CLI при запуске, поместите их в `args` как последовательность строк в кавычках, разделенных запятыми.
4. Для `cwd` укажите `"${workspaceFolder}"`.
5. Для `miDebuggerPath` укажите `"gdb"`.
6. Опционально, но рекомендуется: Добавьте запись после `miDebuggerPath`:
   `"preLaunchTask": "*name-of-your-build-task*",`

Вы должны получить что-то вроде этого:

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "(gdb) Cygwin Launch",
      "type": "cppdbg",
      "request": "launch",
      "program": "${workspaceFolder}/testcpp.exe",
      "args": [],
      "stopAtEntry": false,
      "cwd": "${workspaceFolder}",
      "environment": [],
      "externalConsole": false,
      "MIMode": "gdb",
      "miDebuggerPath": "gdb",
      "preLaunchTask": "C/C++: make -k",
      "setupCommands": [
        {
          "description": "Enable pretty-printing for gdb",
          "text": "-enable-pretty-printing",
          "ignoreFailures": true
        },
        {
          "description": "Set Disassembly Flavor to Intel",
          "text": "-gdb-set disassembly-flavor intel",
          "ignoreFailures": true
        }
      ]
    }
  ]
}
```
