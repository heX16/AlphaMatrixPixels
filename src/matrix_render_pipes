#pragma once

#include "matrix_render.hpp"

namespace amp {

// Base class for effects that use a source matrix.
class csRenderMatrixPipeBase : public csRenderMatrixBase {
public:
    static constexpr uint8_t base = csRenderMatrixBase::paramLast;
    static constexpr uint8_t paramMatrixSource = base + 1;
    static constexpr uint8_t paramLast = paramMatrixSource;

    // Source matrix pointer (nullptr means no source).
    csMatrixPixels* matrixSource = nullptr;

    uint8_t getParamsCount() const override {
        return paramLast;
    }

    void getParamInfo(uint8_t paramNum, csParamInfo& info) override {
        csRenderMatrixBase::getParamInfo(paramNum, info);
        switch (paramNum) {
            case paramMatrixSource:
                info.type = ParamType::Matrix;
                info.name = "Matrix source";
                info.ptr = &matrixSource;
                info.readOnly = false;
                info.disabled = false;
                break;
        }
    }

    void paramChanged(uint8_t paramNum) override {
        csRenderMatrixBase::paramChanged(paramNum);
        if (paramNum == paramMatrixSource) {
            if (renderRectAutosize && matrixSource) {
                rect = matrixSource->getRect();
            }
        }
    }
};

// Effect: copy pixels from source matrix to destination matrix with blending.
class csRenderMatrixCopy : public csRenderMatrixPipeBase {
public:

    void render(csRandGen& /*rand*/, uint16_t /*currTime*/) const override {
        if (disabled || !matrix || !matrixSource) {
            return;
        }

        const csRect target = rect.intersect(matrix->getRect());
        if (target.empty()) {
            return;
        }

        const csRect srcRect = matrixSource->getRect();
        
        // If sizes match, use simple drawMatrix (faster)
        if (rect.width == srcRect.width && rect.height == srcRect.height) {
            matrix->drawMatrix(rect.x, rect.y, *matrixSource);
        } else {
            // Use drawMatrixScale for different sizes
            matrix->drawMatrixScale(srcRect, rect, *matrixSource);
        }
    }
};

} // namespace amp
