# Документация `AlphaMatrixPixels`

## О предназначении этого файла

**Этот файл служит долговременной памятью для GPT ассистента и всех его будущих экземпляров.**

### Важная информация:
- При каждом перезапуске сессии кратковременная память GPT стирается
- Этот файл сохраняет критически важную информацию о проекте между сессиями
- Здесь хранится документация, особенности архитектуры и важные детали реализации
- Файл обновляется по мере развития проекта и получения новой информации

### Инструкции для будущих экземпляров GPT:
1. **Прочитайте этот файл полностью** перед началом работы с проектом
2. **Используйте информацию** из этого файла для понимания контекста
3. **Обновляйте файл** при получении новой важной информации
4. **Добавляйте разделы** по мере необходимости для организации знаний


## Именование

**Название проекта:** AlphaMatrixPixels (сокращенно "AMPix")

**Namespace:** `amp`

- Публичные C++ символы: `namespace amp`.
- Классы/структуры: префикс `cs` + PascalCase (`csMatrixPixels`, `csColorRGBA`, ...).

## Быстрый старт

### Тесты
- Запуск из MSYS2 Bash: `./run_tests.sh`
- Скрипт компилирует и запускает `tests/pixel_matrix_tests.cpp` и печатает `Passed/Failed`.

### Arduino (FastLED)
Скетч `AlphaMatrixPixels.ino` демонстрирует работу с LED-матрицей через FastLED.

### Примечание по AMP_CONSTEXPR
В `fixed_point.hpp` используется макрос `AMP_CONSTEXPR` (по умолчанию `constexpr`), который на Arduino по умолчанию
переключается в `inline`, чтобы избежать проблем старых компиляторов с `constexpr` и float math.

## Основные типы
- `amp::csColorRGBA` — упакованный цвет ARGB; поддерживает конструктор из packed `0xAARRGGBB` и конструктор по каналам `(a,r,g,b)`. Размер гарантирован 4 байта (packed/pragma + static_assert).
- `amp::tMatrixPixelsCoord` (`int32_t`) — координаты (допускает отрицательные смещения для клиппинга).
- `amp::tMatrixPixelsSize` (`uint16_t`) — размеры матрицы.

## API: перечень классов/структур

### `namespace amp`
- `csColorRGBA` (struct) — ARGB цвет (0xAARRGGBB) + операции SourceOver (straight alpha).
- `csMatrixPixels` (class) — матрица пикселей RGBA в памяти + клиппинг/блендинг.
- `csRect` (class) — прямоугольник (x, y, width, height) + пересечение `intersect()`.
- `csRandGen` (class) — простой генератор псевдослучайных чисел (8-bit) для эффектов.
- `csEventBase` (class) — базовый тип события для обмена с внешними системами (WIP).
- `ParamType` (enum class) — тип параметра для внешней интроспекции (WIP).
- `csEffectBase` (class) — базовый интерфейс рендера/эффекта: интроспекция параметров + `paramChanged/recalc/render` + события (WIP).
- `csRenderMatrixBase` (class) — базовый класс для эффектов, которые рисуют в `csMatrixPixels` (см. ниже).

### `namespace amp::math`
- `csFP16` (struct) — signed 8.8 fixed-point.
- `csFP32` (struct) — signed 16.16 fixed-point.

### Важно
- Классы/структуры из `GUI_Test/` и `tests/` (например `csMainProgramSDL`, `TestStats`) **не являются частью библиотеки** — это демо и тестовый код.


## Класс `csColorRGBA`

Формат цвета:
- Packed-формат во входных данных: `0xAARRGGBB` (AA — альфа, затем RR, GG, BB).
- Конструктор по каналам: `csColorRGBA(a, r, g, b)`.
- Конструктор RGB: `csColorRGBA(r, g, b)` (альфа будет `0xFF`).
- Альфа: **straight alpha** (не premultiplied).
- Композиция: Porter-Duff **SourceOver**.

- Формат ARGB: порядок байт A,R,G,B при доступе через `raw`/`value` соответствует `0xAARRGGBB`.

### Особенности `csColorRGBA`
- Конструктор по каналам: порядок аргументов **`(a, r, g, b)`**.
- Конструктор из `uint32_t packed`: имеет необычные оссобености работы с альфа каналом, читай код перед использованием.

### Алгоритм смешивания (для одного канала, нормализовано к `0..1`)
```
// Porter-Duff SourceOver: источник рисуется поверх назначения
A_src = src.a * global_alpha  // эффективная альфа источника
Aout = A_src + A_dst * (1 - A_src)  // итоговая альфа
Cout = (C_src * A_src + C_dst * A_dst * (1 - A_src)) / Aout
```
Примечание: в реальной реализации используется целочисленная uint8 арифметика нормализованная к `0..255`.




## Класс `csMatrixPixels`

**Исходник:** `matrix_pixels.hpp`

2D-матрица пикселей ARGB (0xAARRGGBB).

### Ключевые особенности

- **Безопасные границы:** запись вне границ игнорируется, чтение возвращает `{0,0,0,0}`.
- **Метод `getRect()`:** возвращает `csRect{0,0,width,height}` — используется для клиппинга в рендерах.
- **Метод `drawMatrix()`:** композиция матриц с автоклиппингом.

## Система рендеринга

**Исходник:** `matrix_render.hpp`

### Ключевые принципы

**Публичные поля** — все данные в `csRender*` классах `public`, без get/set. Это сознательное решение для производительности и простоты.

### Интроспекции - система свойств

Система динамического доступа к параметрам эффектов в runtime. Позволяет внешним системам (GUI, скрипты, сериализация) получать список параметров, их типы, имена и указатели на данные без знания конкретного типа эффекта.

API:
- **`getParamsCount()`** — возвращает количество доступных параметров.
- **`getParamInfo(paramNum, info)`** — заполняет `csParamInfo` для параметра с номером `paramNum` (нумерация с 1).
- **`paramChanged(paramNum)`** — вызывается при изменении параметра (для обновления кэша, пересчёта зависимостей). Нумерация с 1!

### Область рендера (`rect`)

Каждый рендер, наследующий `csRenderMatrixBase`, имеет поле `rect` типа `csRect`. Эффект рисует **только внутри этого прямоугольника**.

**Режим autosize (по умолчанию):**
- `renderRectAutosize = true`
- `rect` автоматически равен размеру матрицы (зависит от реализации конкретного класса)

**Ручной режим:**
- `renderRectAutosize = false`
- `rect` задаётся вручную: `plasma.rect = csRect{x, y, w, h};`
- Это позволяет рисовать эффект в произвольной области матрицы (смещение, уменьшенный размер)

```cpp
plasma.renderRectAutosize = false;
plasma.rect = csRect{2, 2, 4, 4};  // рисовать только в квадрате 4×4 со смещением (2,2)
```

### Минимальный пример

```cpp
amp::csMatrixPixels canvas(8, 8);
amp::csRenderPlasma plasma;
amp::csRandGen rng;

plasma.setMatrix(canvas);  // важно: устанавливает matrix И обновляет rect

plasma.render(rng, (uint16_t)millis());
```

